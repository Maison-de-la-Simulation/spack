#/bin/bash
set -e

COMPILER_NAME="$(echo ${COMPILER} | sed 's/@.*//')"
COMPILER_VERSION="$(echo ${COMPILER} | sed 's/^[^@]*//')"

echo "Installing compiler ${COMPILER_NAME} (${COMPILER_VERSION})"

if ! spack compilers | grep "${COMPILER}" &>/dev/null
then
    if [[ "${COMPILER_NAME}" == "intel" || "${COMPILER_NAME}" == "oneapi" ]]
    then
        for N in {2..${PARALLELISM}}
        do spack install ${SPACK_INSTALL_ARGS} intel-oneapi-compilers${COMPILER_VERSION} &
        done
        spack install ${SPACK_INSTALL_ARGS} intel-oneapi-compilers${COMPILER_VERSION} || \
        tail -n +1 -- /tmp/root/spack-stage/spack-stage-*/spack-*-out.txt
        spack load intel-oneapi-compilers${COMPILER_VERSION}
    else
        for N in {2..${PARALLELISM}}
        do spack install ${SPACK_INSTALL_ARGS} "${COMPILER}" &
        done
        spack install ${SPACK_INSTALL_ARGS} "${COMPILER}" || \
        tail -n +1 -- /tmp/root/spack-stage/spack-stage-*/spack-*-out.txt
        spack load "${COMPILER}"
    fi
    spack compiler find
fi
